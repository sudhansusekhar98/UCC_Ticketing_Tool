/**
 * Full Seed Script
 * 
 * Creates all collections with comprehensive sample data
 * Use this if you cannot migrate from SQL Server
 * 
 * Usage: npm run seed:full
 */

import mongoose from 'mongoose';
import dotenv from 'dotenv';
import { hashPassword } from '../utils/auth.utils.js';

// Import all models
import User from '../models/User.model.js';
import Site from '../models/Site.model.js';
import Asset from '../models/Asset.model.js';
import Ticket from '../models/Ticket.model.js';
import SLAPolicy from '../models/SLAPolicy.model.js';
import TicketActivity from '../models/TicketActivity.model.js';
import WorkOrder from '../models/WorkOrder.model.js';

dotenv.config();

// Store created document IDs for relationships
let createdSites = [];
let createdUsers = [];
let createdAssets = [];
let createdTickets = [];
let createdSlaPolicies = [];

async function seedSLAPolicies() {
  console.log('\nüìã Creating SLA Policies...');

  await SLAPolicy.deleteMany({});

  const policies = [
    {
      policyName: 'P1 - Critical Priority',
      priority: 'P1',
      responseTimeMinutes: 15,
      restoreTimeMinutes: 60,
      escalationLevel1Minutes: 30,
      escalationLevel2Minutes: 45,
      escalationL1Emails: 'supervisor@ticketops.vluccc.com',
      escalationL2Emails: 'admin@ticketops.vluccc.com',
      isActive: true
    },
    {
      policyName: 'P2 - High Priority',
      priority: 'P2',
      responseTimeMinutes: 30,
      restoreTimeMinutes: 240,
      escalationLevel1Minutes: 120,
      escalationLevel2Minutes: 180,
      escalationL1Emails: 'supervisor@ticketops.vluccc.com',
      escalationL2Emails: 'admin@ticketops.vluccc.com',
      isActive: true
    },
    {
      policyName: 'P3 - Medium Priority',
      priority: 'P3',
      responseTimeMinutes: 60,
      restoreTimeMinutes: 480,
      escalationLevel1Minutes: 240,
      escalationLevel2Minutes: 360,
      escalationL1Emails: 'supervisor@ticketops.vluccc.com',
      escalationL2Emails: 'admin@ticketops.vluccc.com',
      isActive: true
    },
    {
      policyName: 'P4 - Low Priority',
      priority: 'P4',
      responseTimeMinutes: 120,
      restoreTimeMinutes: 1440,
      escalationLevel1Minutes: 720,
      escalationLevel2Minutes: 1080,
      escalationL1Emails: 'supervisor@ticketops.vluccc.com',
      escalationL2Emails: 'admin@ticketops.vluccc.com',
      isActive: true
    }
  ];

  createdSlaPolicies = await SLAPolicy.insertMany(policies);
  console.log(`  ‚úÖ Created ${createdSlaPolicies.length} SLA Policies`);
}

async function seedSites() {
  console.log('\nüìã Creating Sites...');

  await Site.deleteMany({});

  const sites = [
    {
      siteName: 'City Center Command Station',
      siteUniqueID: 'CCCS-001',
      city: 'Bhubaneswar',
      zone: 'Central Zone',
      ward: 'Ward 1',
      address: 'Master Canteen Square, Bhubaneswar, Odisha 751001',
      latitude: 20.2961,
      longitude: 85.8245,
      contactPerson: 'Ramesh Kumar',
      contactPhone: '9876543210',
      isActive: true
    },
    {
      siteName: 'Airport Junction Surveillance',
      siteUniqueID: 'AJS-002',
      city: 'Bhubaneswar',
      zone: 'Airport Zone',
      ward: 'Ward 15',
      address: 'Biju Patnaik International Airport, Bhubaneswar',
      latitude: 20.2444,
      longitude: 85.8178,
      contactPerson: 'Suresh Patra',
      contactPhone: '9876543211',
      isActive: true
    },
    {
      siteName: 'Railway Station Hub',
      siteUniqueID: 'RSH-003',
      city: 'Bhubaneswar',
      zone: 'Railway Zone',
      ward: 'Ward 5',
      address: 'Bhubaneswar Railway Station, Bhubaneswar',
      latitude: 20.2683,
      longitude: 85.8410,
      contactPerson: 'Prasanna Sahoo',
      contactPhone: '9876543212',
      isActive: true
    },
    {
      siteName: 'Patia Junction',
      siteUniqueID: 'PJ-004',
      city: 'Bhubaneswar',
      zone: 'North Zone',
      ward: 'Ward 18',
      address: 'Patia Square, NH-16, Bhubaneswar',
      latitude: 20.3486,
      longitude: 85.8194,
      contactPerson: 'Bikash Mohanty',
      contactPhone: '9876543213',
      isActive: true
    },
    {
      siteName: 'Infocity IT Park',
      siteUniqueID: 'IIP-005',
      city: 'Bhubaneswar',
      zone: 'IT Zone',
      ward: 'Ward 20',
      address: 'Chandaka Industrial Estate, Infocity, Bhubaneswar',
      latitude: 20.3235,
      longitude: 85.8067,
      contactPerson: 'Deepak Nayak',
      contactPhone: '9876543214',
      isActive: true
    },
    {
      siteName: 'Kalinga Stadium',
      siteUniqueID: 'KS-006',
      city: 'Bhubaneswar',
      zone: 'Sports Zone',
      ward: 'Ward 22',
      address: 'Kalinga Stadium Road, Bhubaneswar',
      latitude: 20.2875,
      longitude: 85.8202,
      contactPerson: 'Manoranjan Das',
      contactPhone: '9876543215',
      isActive: true
    }
  ];

  createdSites = await Site.insertMany(sites);
  console.log(`  ‚úÖ Created ${createdSites.length} Sites`);
}

async function seedUsers() {
  console.log('\nüìã Creating Users...');

  await User.deleteMany({});

  const users = [
    {
      fullName: 'System Administrator',
      email: 'admin@ticketops.vluccc.com',
      username: 'admin',
      passwordHash: await hashPassword('Admin@123'),
      role: 'Admin',
      designation: 'System Administrator',
      mobileNumber: '9999999999',
      isActive: true
    },
    {
      fullName: 'Chief Dispatcher',
      email: 'dispatcher@ticketops.vluccc.com',
      username: 'dispatcher',
      passwordHash: await hashPassword('Dispatcher@123'),
      role: 'Dispatcher',
      designation: 'Chief Dispatcher',
      mobileNumber: '9999999998',
      isActive: true
    },
    {
      fullName: 'Rajesh Sharma',
      email: 'rajesh.sharma@ticketops.vluccc.com',
      username: 'rajesh.sharma',
      passwordHash: await hashPassword('Engineer@123'),
      role: 'L1Engineer',
      designation: 'Field Engineer L1',
      mobileNumber: '9999999997',
      siteId: createdSites[0]._id,
      isActive: true
    },
    {
      fullName: 'Priya Patel',
      email: 'priya.patel@ticketops.vluccc.com',
      username: 'priya.patel',
      passwordHash: await hashPassword('Engineer@123'),
      role: 'L1Engineer',
      designation: 'Field Engineer L1',
      mobileNumber: '9999999996',
      siteId: createdSites[1]._id,
      isActive: true
    },
    {
      fullName: 'Amit Kumar',
      email: 'amit.kumar@ticketops.vluccc.com',
      username: 'amit.kumar',
      passwordHash: await hashPassword('Engineer@123'),
      role: 'L2Engineer',
      designation: 'Senior Engineer L2',
      mobileNumber: '9999999995',
      siteId: createdSites[0]._id,
      isActive: true
    },
    {
      fullName: 'Sneha Das',
      email: 'sneha.das@ticketops.vluccc.com',
      username: 'sneha.das',
      passwordHash: await hashPassword('Engineer@123'),
      role: 'L2Engineer',
      designation: 'Senior Engineer L2',
      mobileNumber: '9999999994',
      siteId: createdSites[2]._id,
      isActive: true
    },
    {
      fullName: 'Operations Supervisor',
      email: 'supervisor@ticketops.vluccc.com',
      username: 'supervisor',
      passwordHash: await hashPassword('Supervisor@123'),
      role: 'Supervisor',
      designation: 'Operations Supervisor',
      mobileNumber: '9999999993',
      isActive: true
    },
    {
      fullName: 'Client Viewer',
      email: 'client@ticketops.vluccc.com',
      username: 'client',
      passwordHash: await hashPassword('Client@123'),
      role: 'ClientViewer',
      designation: 'Client Representative',
      mobileNumber: '9999999992',
      isActive: true
    }
  ];

  createdUsers = await User.insertMany(users);
  console.log(`  ‚úÖ Created ${createdUsers.length} Users`);
}

async function seedAssets() {
  console.log('\nüìã Creating Assets...');

  await Asset.deleteMany({});

  const assetTypes = ['Camera', 'NVR', 'Switch', 'Router', 'Server'];
  const assetStatuses = ['Operational', 'Degraded', 'Offline', 'Maintenance'];
  const makes = ['Hikvision', 'Dahua', 'Axis', 'Cisco', 'HP', 'Dell'];
  const models = ['DS-2CD2183G2-I', 'IPC-HFW2831S', 'P3245-V', 'SG300-28', 'ProLiant DL380'];

  const assets = [];
  let assetCounter = 1;

  for (const site of createdSites) {
    // Create 5-10 assets per site
    const assetCount = Math.floor(Math.random() * 6) + 5;

    for (let i = 0; i < assetCount; i++) {
      const assetType = assetTypes[Math.floor(Math.random() * assetTypes.length)];
      const make = makes[Math.floor(Math.random() * makes.length)];

      assets.push({
        assetCode: `AST-${String(assetCounter).padStart(4, '0')}`,
        assetType,
        serialNumber: `SN-${Date.now()}-${assetCounter}`,
        mac: `00:1A:2B:3C:${String(assetCounter).padStart(2, '0')}:FF`,
        siteId: site._id,
        locationDescription: `Building ${Math.ceil(assetCounter / 10)}, Floor ${(assetCounter % 3) + 1}`,
        criticality: Math.floor(Math.random() * 3) + 1,
        status: assetStatuses[Math.floor(Math.random() * assetStatuses.length)],
        installationDate: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000),
        warrantyEndDate: new Date(Date.now() + Math.random() * 730 * 24 * 60 * 60 * 1000),
        make,
        model: models[Math.floor(Math.random() * models.length)],
        managementIP: `192.168.${Math.floor(assetCounter / 255)}.${assetCounter % 255}`,
        locationName: site.siteName,
        deviceType: assetType,
        usedFor: 'Surveillance',
        isActive: true
      });

      assetCounter++;
    }
  }

  createdAssets = await Asset.insertMany(assets);
  console.log(`  ‚úÖ Created ${createdAssets.length} Assets`);
}

async function seedTickets() {
  console.log('\nüìã Creating Tickets...');

  await Ticket.deleteMany({});

  const categories = ['Hardware', 'Software', 'Network', 'Power', 'Connectivity'];
  const subCategories = {
    Hardware: ['Camera Malfunction', 'NVR Failure', 'Cable Damage', 'Physical Damage'],
    Software: ['Firmware Update', 'Configuration Issue', 'Application Crash'],
    Network: ['Connectivity Loss', 'Bandwidth Issue', 'IP Conflict'],
    Power: ['Power Outage', 'UPS Failure', 'Electrical Surge'],
    Connectivity: ['No Video Feed', 'Intermittent Connection', 'Stream Quality']
  };
  const statuses = ['Open', 'Assigned', 'Acknowledged', 'InProgress', 'OnHold', 'Resolved', 'Closed'];
  const priorities = ['P1', 'P2', 'P3', 'P4'];

  const tickets = [];
  const dispatcher = createdUsers.find(u => u.role === 'Dispatcher');
  const engineers = createdUsers.filter(u => u.role === 'L1Engineer' || u.role === 'L2Engineer');

  // Generate date for ticket number
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');

  for (let i = 1; i <= 25; i++) {
    const category = categories[Math.floor(Math.random() * categories.length)];
    const subCat = subCategories[category][Math.floor(Math.random() * subCategories[category].length)];
    const status = statuses[Math.floor(Math.random() * statuses.length)];
    const priority = priorities[Math.floor(Math.random() * priorities.length)];
    const asset = createdAssets[Math.floor(Math.random() * createdAssets.length)];
    const assignedEngineer = status !== 'Open' ? engineers[Math.floor(Math.random() * engineers.length)] : null;
    const slaPolicy = createdSlaPolicies.find(p => p.priority === priority);

    const createdDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);

    tickets.push({
      ticketNumber: `TKT-${dateStr}-${String(i).padStart(4, '0')}`,
      assetId: asset._id,
      siteId: asset.siteId,
      category,
      subCategory: subCat,
      title: `${subCat} - ${asset.assetCode}`,
      description: `Issue reported at ${asset.locationName}. ${subCat} needs attention.`,
      priority,
      priorityScore: Math.floor(Math.random() * 50) + 10,
      impact: Math.floor(Math.random() * 5) + 1,
      urgency: Math.floor(Math.random() * 5) + 1,
      status,
      source: 'Manual',
      createdBy: dispatcher._id,
      assignedTo: assignedEngineer?._id || null,
      slaPolicyId: slaPolicy?._id,
      assignedOn: status !== 'Open' ? new Date(createdDate.getTime() + 15 * 60 * 1000) : null,
      acknowledgedOn: ['Acknowledged', 'InProgress', 'Resolved', 'Closed'].includes(status)
        ? new Date(createdDate.getTime() + 30 * 60 * 1000) : null,
      resolvedOn: ['Resolved', 'Closed'].includes(status)
        ? new Date(createdDate.getTime() + 120 * 60 * 1000) : null,
      closedOn: status === 'Closed'
        ? new Date(createdDate.getTime() + 180 * 60 * 1000) : null,
      slaResponseDue: new Date(createdDate.getTime() + slaPolicy.responseTimeMinutes * 60 * 1000),
      slaRestoreDue: new Date(createdDate.getTime() + slaPolicy.restoreTimeMinutes * 60 * 1000),
      isSLAResponseBreached: Math.random() > 0.8,
      isSLARestoreBreached: Math.random() > 0.9,
      escalationLevel: Math.floor(Math.random() * 3),
      rootCause: ['Resolved', 'Closed'].includes(status) ? 'Hardware component failure' : null,
      resolutionSummary: ['Resolved', 'Closed'].includes(status) ? 'Replaced faulty component' : null,
      requiresVerification: true,
      createdAt: createdDate
    });
  }

  createdTickets = await Ticket.insertMany(tickets);
  console.log(`  ‚úÖ Created ${createdTickets.length} Tickets`);
}

async function seedTicketActivities() {
  console.log('\nüìã Creating Ticket Activities...');

  await TicketActivity.deleteMany({});

  const activityTypes = ['Comment', 'StatusChange', 'Assignment', 'Resolution'];
  const activities = [];

  for (const ticket of createdTickets) {
    // Add 1-5 activities per ticket
    const activityCount = Math.floor(Math.random() * 5) + 1;

    for (let i = 0; i < activityCount; i++) {
      const activityType = activityTypes[Math.floor(Math.random() * activityTypes.length)];
      const user = createdUsers[Math.floor(Math.random() * createdUsers.length)];

      let content = '';
      switch (activityType) {
        case 'Comment':
          content = 'Investigating the issue. Will update shortly.';
          break;
        case 'StatusChange':
          content = `Status changed to ${ticket.status}`;
          break;
        case 'Assignment':
          content = `Ticket assigned to engineer`;
          break;
        case 'Resolution':
          content = 'Issue has been resolved. Component replaced.';
          break;
      }

      activities.push({
        ticketId: ticket._id,
        userId: user._id,
        activityType,
        content,
        isInternal: Math.random() > 0.7,
        createdOn: new Date(ticket.createdAt.getTime() + (i * 30 * 60 * 1000))
      });
    }
  }

  const createdActivities = await TicketActivity.insertMany(activities);
  console.log(`  ‚úÖ Created ${createdActivities.length} Ticket Activities`);
}

async function seedWorkOrders() {
  console.log('\nüìã Creating Work Orders...');

  await WorkOrder.deleteMany({});

  const workOrderStatuses = ['Pending', 'Accepted', 'InProgress', 'Completed'];
  const workOrders = [];

  const engineers = createdUsers.filter(u => u.role === 'L1Engineer' || u.role === 'L2Engineer');
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');

  // Create work orders for some tickets
  const ticketsWithWO = createdTickets.filter(t =>
    ['Assigned', 'Acknowledged', 'InProgress', 'Resolved', 'Closed'].includes(t.status)
  );

  let woCounter = 1;
  for (const ticket of ticketsWithWO.slice(0, 15)) {
    const engineer = engineers[Math.floor(Math.random() * engineers.length)];
    const status = workOrderStatuses[Math.floor(Math.random() * workOrderStatuses.length)];

    workOrders.push({
      workOrderNumber: `WO-${dateStr}-${String(woCounter).padStart(4, '0')}`,
      ticketId: ticket._id,
      engineerId: engineer._id,
      status,
      workOrderType: 'Corrective',
      checklistJson: JSON.stringify([
        { item: 'Verify power supply', completed: Math.random() > 0.5 },
        { item: 'Check network connectivity', completed: Math.random() > 0.5 },
        { item: 'Test camera feed', completed: Math.random() > 0.5 },
        { item: 'Document findings', completed: Math.random() > 0.5 }
      ]),
      partsUsedJson: status === 'Completed' ? JSON.stringify([
        { part: 'Power Cable', quantity: 1 },
        { part: 'Network Cable', quantity: 2 }
      ]) : null,
      scheduledDate: new Date(ticket.createdAt.getTime() + 24 * 60 * 60 * 1000),
      startedOn: ['InProgress', 'Completed'].includes(status)
        ? new Date(ticket.createdAt.getTime() + 2 * 60 * 60 * 1000) : null,
      completedOn: status === 'Completed'
        ? new Date(ticket.createdAt.getTime() + 4 * 60 * 60 * 1000) : null,
      workPerformed: status === 'Completed' ? 'Replaced faulty cable and tested connectivity' : null,
      remarks: 'Standard maintenance procedure followed',
      requiresApproval: false
    });

    woCounter++;
  }

  const createdWorkOrders = await WorkOrder.insertMany(workOrders);
  console.log(`  ‚úÖ Created ${createdWorkOrders.length} Work Orders`);
}

async function seedSystemSettings() {
  console.log('\nüìã Creating System Settings...');

  const settingsCollection = mongoose.connection.collection('systemsettings');
  await settingsCollection.deleteMany({});

  const settings = [
    { key: 'company_name', value: 'TicketOps', dataType: 'string', category: 'General', description: 'Company name displayed in the application' },
    { key: 'default_priority', value: 'P3', dataType: 'string', category: 'Tickets', description: 'Default priority for new tickets' },
    { key: 'sla_check_interval', value: '60', dataType: 'number', category: 'SLA', description: 'SLA check interval in seconds' },
    { key: 'email_notifications', value: 'true', dataType: 'boolean', category: 'Notifications', description: 'Enable email notifications' },
    { key: 'max_file_size', value: '10485760', dataType: 'number', category: 'Uploads', description: 'Maximum file upload size in bytes' },
    { key: 'session_timeout', value: '60', dataType: 'number', category: 'Security', description: 'Session timeout in minutes' }
  ];

  await settingsCollection.insertMany(settings);
  console.log(`  ‚úÖ Created ${settings.length} System Settings`);
}

async function printSummary() {
  console.log('\n' + '‚ïê'.repeat(60));
  console.log('üìä SEED SUMMARY');
  console.log('‚ïê'.repeat(60));

  const counts = {
    'SLA Policies': await SLAPolicy.countDocuments(),
    'Sites': await Site.countDocuments(),
    'Users': await User.countDocuments(),
    'Assets': await Asset.countDocuments(),
    'Tickets': await Ticket.countDocuments(),
    'Ticket Activities': await TicketActivity.countDocuments(),
    'Work Orders': await WorkOrder.countDocuments()
  };

  let total = 0;
  for (const [name, count] of Object.entries(counts)) {
    console.log(`‚úÖ ${name.padEnd(20)} : ${count}`);
    total += count;
  }

  console.log('‚îÄ'.repeat(60));
  console.log(`üìà TOTAL DOCUMENTS      : ${total}`);
  console.log('‚ïê'.repeat(60));
}

async function seedDatabase() {
  console.log('\n' + '‚ïê'.repeat(60));
  console.log('üå± FULL DATABASE SEED');
  console.log('‚ïê'.repeat(60));
  console.log(`Started at: ${new Date().toISOString()}\n`);

  try {
    // Connect to MongoDB
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('‚úÖ Connected to MongoDB');

    // Seed in order (respecting dependencies)
    await seedSLAPolicies();
    await seedSites();
    await seedUsers();
    await seedAssets();
    await seedTickets();
    await seedTicketActivities();
    await seedWorkOrders();
    await seedSystemSettings();

    // Print summary
    await printSummary();

    console.log('\nüìù Default Login Credentials:');
    console.log('‚îÅ'.repeat(60));
    console.log('Admin:       username: admin          | password: Admin@123');
    console.log('Dispatcher:  username: dispatcher     | password: Dispatcher@123');
    console.log('L1 Engineer: username: rajesh.sharma  | password: Engineer@123');
    console.log('L2 Engineer: username: amit.kumar     | password: Engineer@123');
    console.log('Supervisor:  username: supervisor     | password: Supervisor@123');
    console.log('Client:      username: client         | password: Client@123');
    console.log('‚îÅ'.repeat(60));

    console.log('\nüéâ Database seeded successfully!');
    console.log(`Completed at: ${new Date().toISOString()}`);

  } catch (error) {
    console.error('\n‚ùå Seed failed:', error);
  } finally {
    await mongoose.connection.close();
    console.log('üîå MongoDB connection closed');
    process.exit(0);
  }
}

// Run seed
seedDatabase();
